<html>
    <head>
        <title>Airplanes</title>
        <link rel="icon" type="image/x-icon" href="favicon.png" />
        <link rel='shortcut icon' type='image/x-icon' href='favicon.ico' />
        <link rel="manifest" href="manifest.json" />
        <style>html{background-color:#000;color:#fff;font-family:'Courier New',Courier,monospace;font-size:calc(min(100vw / 12, 100vh / 28))}[type=range]{width:11rem}body{margin:1rem}#my-field>*,#opponent-field>*,#plane-field>*,body>*{display:flex;flex-direction:column;align-items:center}body>:not(link,style,script,:last-child){margin-bottom:1rem}table{border-collapse:collapse}td{width:1rem;height:1rem;overflow:hidden;font-size:.75rem;overflow:hidden;padding:0;text-align:center}td[cell]{border:1px solid grey}.square{display:inline-block;width:1rem;height:1rem;overflow:hidden;font-size:.75rem}.border{box-shadow:1px 0 0 0 grey,0 1px 0 0 grey,1px 1px 0 0 grey,1px 0 0 0 grey inset,0 1px 0 0 grey inset}.disabled{background-color:grey}.plane{background-color:#87cefa}.hit{background-color:grey}.plane.hit{background-color:orange}.plane.tip.hit{background-color:red}.rotate{width:calc(100% - .5rem)}.game-over{position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.753)}.game-over>*{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);white-space:nowrap}.game-over>.won{color:#adff2f}.game-over>.lost{color:red}</style>
        <script type="module">(()=>{var p=Object.freeze({myField:"my-field",opponentField:"opponent-field",planeField:"plane-field"}),a,A=Object.freeze({max:6,get value(){return+localStorage.getItem("level")||3},set value(e){localStorage.setItem("level",e>=1&&e<=A.max?e:3)}});Promise.resolve().then(async()=>{if(await H(),10<5||10>25)throw Error("GRID_SIZE must be between 5 and 25");if(2<1||2>Math.floor(10*10/16))throw Error(`PLANE_COUNT must be between 1 and ${Math.floor(10*10/16)}`);a.my.planes.length!==2&&v().settings().add(),v().myBattlefield().add(),a.my.planes.length===2&&(v().opponentBattlefield().add(),P(!0))}).catch(e=>{f().innerHTML=`<button onclick="javascript:location.reload()">reload</button><br><br>${e.stack}`});function v(){function e(t,n,s,r){let o=n+(s?1:0);return d("div",{children:[d("div",{text:t}),d("table",{children:C(o).map((h,m)=>d("tr",{children:C(o).map((l,c)=>d("td",{...(()=>s&&m===0&&c===0?{text:""}:s&&m===0&&c>0?{text:c}:s&&m>0&&c===0?{text:j(m)}:{attrs:{cell:I(m+(s?0:1),c+(s?0:1))}})()}))})),on:{click(h){h.preventDefault(),h.stopPropagation(),r(h.target.getAttribute("cell"))}}})]})}return Object.freeze({settings:()=>Object.freeze({add:()=>{d("div",{parent:f(),attrs:{id:"level",class:"settings"},children:[d("div",{text:"Difficulty"}),d("input",{attrs:{type:"range",min:1,max:6,value:A.value},on:{change(t){A.value=+t.target.value}}})]}),d("div",{parent:f(),attrs:{id:p.planeField,class:"settings"},children:e("Add plane (click to rotate)",4,!1,G)}),G(),D()},remove:()=>w(".settings").forEach(t=>t.remove())}),myBattlefield:()=>Object.freeze({add:()=>{d("div",{parent:f(),attrs:{id:p.myField},children:e("My battlefield",10,!0,q)}),a.my.planes.forEach(t=>T(p.myField,t)),a.my.planes.length!==2&&D(),P(!1)}}),opponentBattlefield:()=>Object.freeze({add:()=>{d("div",{parent:f(),attrs:{id:p.opponentField},children:e("Opponent's battlefield",10,!0,J)}),x()}})})}async function H(){a=await Promise.resolve({my:{planes:[],shots:[]},opponent:{planes:[],shots:[]}})}function q(e){if(!U(e)||a.my.planes.length===2)return;let[t,n]=E(e),s=L(t,n,R(),a.my.planes);s&&(a.my.planes.push(s),T(p.myField,s)),D(),a.my.planes.length===2&&(v().settings().remove(),v().opponentBattlefield().add())}function x(){for(;a.opponent.planes.length!==2;){let e=L(y(10),y(10),y(4),a.opponent.planes);e&&a.opponent.planes.push(e)}}async function Y(){let e=()=>{for(;;){let l=[y(10),y(10)];if(!a.opponent.shots.includes(I(...l)))return l}},t=()=>e(),n=()=>e(),s=()=>{let l=a.my.planes.flatMap(i=>i),c=a.opponent.shots;if(!c)return e();let _=c.filter(i=>l.includes(i));if(!_)return e();let z=l.map(i=>i[0]).filter(i=>_.includes(i)),k=_.filter(i=>!z.includes(i));if(!_)return e();let F=[...new Set(k.flatMap(i=>{let[S,b]=E(i),Z=C(7,S-3).map((u,g)=>u+g).filter(u=>u>=1&&u<=10),O=C(7,b-3).map((u,g)=>u+g).filter(u=>u>=1&&u<=10);return Z.flatMap(u=>O.map(g=>[u,g]))}).map(([i,S])=>I(i,S)))].filter(i=>!c.includes(i));if(!F.length)return e();let N=[...new Set(F.flatMap(i=>{let[S,b]=E(i);return[1,2,3,4].flatMap(O=>L(S,b,O,[c],!0)||[])}))];if(N.length)return E(N[y(N.length)-1])},r=()=>s()||e();await K(I(...([t,n,r,()=>{if(a.my.planes.flatMap(c=>c).filter(c=>a.opponent.shots.includes(c)))return e()},()=>E(a.my.planes.flatMap(l=>l).reverse()[a.opponent.shots.length]),()=>E(a.my.planes[a.opponent.shots.length][0])][A.value-1]||r)()||r()))}function L(e,t,n,s,r){if(!(n===1&&e>=1&&e<=10-3&&t>=2&&t<=10-1||n===2&&e>=2&&e<=10-1&&t>=4&&t<=10||n===3&&e>=4&&e<=10&&t>=2&&t<=10-1||n===4&&e>=2&&e<=10-1&&t>=1&&t<=10-3))return;let o=M(n,e,t),h=s.find(m=>m.find(l=>o.includes(l))!==void 0);if(!(h&&!r))return o}function G(){let e=R(),t=e+(e>=4?-3:1),n=M(t),s=f(`#${p.planeField}`);s.setAttribute("orientation",t),s.querySelectorAll("[cell]").forEach(r=>n.includes(r.getAttribute("cell"))?r.classList.add("plane"):r.classList.remove("plane")),D()}function D(){let e=Array.prototype.slice.call(w(`#${p.myField} [cell]`));if(a.my.planes.length===2){e.forEach(n=>n.classList.remove("disabled"));return}e.forEach(n=>n.classList.add("disabled"));let t=R();[...new Set(e.flatMap(n=>{let[s,r]=E(n.getAttribute("cell")),o=L(s,r,t,a.my.planes);return o?o[0]:[]}))].forEach(n=>f(`#${p.myField} [cell='${n}']`).classList.remove("disabled"))}function R(){let e=f(`#${p.planeField}`),t=e&&+e.getAttribute("orientation")||1;return t>4?1:t}async function J(e){if(!U(e)||!Q()||a.my.shots.includes(e))return;a.my.shots.push(e);let t=await(async()=>{switch(!0){case a.opponent.planes.find(s=>s[0]===e)!==void 0:return 2;case a.opponent.planes.find(s=>s.includes(e))!==void 0:return 1;case!1:return await Promise.resolve(y(3)-1);default:return 0}})(),n=f(`#${p.opponentField} [cell='${e}']`);t>0&&n.classList.add("plane"),t===2&&n.classList.add("tip"),P(!0,e),(t===3||B(a.opponent.planes,a.my.shots))&&await $("my"),Y()}async function K(e){a.opponent.shots.includes[e]||a.opponent.shots.push(e),P(!1,e),B(a.my.planes,a.opponent.shots)&&await $("opponent")}async function $(e){a.opponent.planes.forEach(n=>n.forEach(s=>f(`#${p.opponentField} [cell='${s}']`).classList.add("plane"))),d("div",{parent:f(),attrs:{class:"game-over"},on:{click(){location.reload()}},children:d("div",{text:e==="my"?"You won :)":"You lost :(",attrs:{class:e==="my"?"won":"lost"}})})}function B(e,t){let n=e.map(r=>r[0]);return t.filter(r=>n.includes(r)).length===2}function T(e,t){t.forEach((n,s)=>{let r=f(`#${e} [cell='${n}']`);r.classList.add("plane"),s===0&&r.classList.add("tip")})}function P(e,t){let n=f(`#${e?p.opponentField:p.myField}`);t?s(t):e?a.my.shots.forEach(s):a.opponent.shots.forEach(s);function s(r){let o=n.querySelector(`[cell='${r}']`);o.classList.contains("hit")||o.classList.add("hit")}}function M(e,t,n){let s={1:["A2","B2","B1","B3","C2","D2","D1","D3"],2:["B4","B3","A3","C3","B2","B1","A1","C1"],3:["D2","C2","C1","C3","B2","A2","A1","A3"],4:["B1","B2","A2","C2","B3","B4","A4","C4"]},r=h=>h.map(m=>{let l=E(m);return l[0]+=e===1?t-1:e==2||e==4?t-2:e===3?t-4:t,l[1]+=e===1||e===3?n-2:e==2?n-4:e===4?n-1:n,I(...l)}),o=s[e];return t&&n?r(o):o}function f(e){return e?document.querySelector(e):document.body}function w(e){return document.querySelectorAll(e)}function d(e,t){let n=document.createElement(e);return t&&(t.attrs&&Object.entries(t.attrs).forEach(([s,r])=>r&&n.setAttribute(s,r)),t.text&&(n.innerText=t.text),t.children&&(t.children instanceof Array?t.children.forEach(s=>n.appendChild(s)):n.appendChild(t.children)),t.on&&Object.entries(t.on).forEach(([s,r])=>n.addEventListener(s,r)),t.parent&&t.parent.appendChild(n)),n}function Q(){return a.my.shots.length<=a.opponent.shots.length}function C(e,t){return new Array(e).fill(t)}function y(e){return Math.ceil(Math.random()*e)}function U(e){return e===I(...E(e))}function j(e){return String.fromCharCode(64+e)}function I(e,t){return`${j(e)}${t}`}function E(e){return/^[A-Z]{1}[1-9]{1}[0-9]?$/.test(e||"")?[e[0].charCodeAt()-64,+e.replace(/[A-Z]/,"")]:[NaN,NaN]}})();</script>
    </head>
</html>
