<html>
    <head>
        <title>Airplanes</title>
    </head>
    <body>
        <style>html{background-color:#000;color:#fff;font-size:32px;font-family:'Courier New',Courier,monospace}button{margin:.25rem;padding:.25rem;background-color:#000;color:#fff;border:1px solid grey}button.selected{background-color:grey}table{border-collapse:collapse}td{width:1rem;height:1rem;overflow:hidden;font-size:.75rem;overflow:hidden;padding:0;text-align:center}td[cell]{border:1px solid grey}.block{display:inline-block;margin:.5rem}.square{display:inline-block;width:1rem;height:1rem;overflow:hidden;font-size:.75rem}.border{box-shadow:1px 0 0 0 #888,0 1px 0 0 #888,1px 1px 0 0 #888,1px 0 0 0 #888 inset,0 1px 0 0 #888 inset}.plane-tmp{background-color:orange}.indicator{background-color:#a9a9a9}.plane{background-color:#87cefa}.hit{background-color:grey}.plane.hit{background-color:orange}.plane.tip.hit{background-color:red}.rotate{width:calc(100% - .5rem)}.game-over{position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.753)}.game-over>*{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);white-space:nowrap}.game-over>.won{color:#adff2f}.game-over>.lost{color:red}</style>
        <script type="module">(()=>{var c={myField:"my-field",opponentField:"opponent-field",planeField:"plane-field"},l;Promise.resolve().then(async()=>{await $(),R(),N(),l.my.planes.forEach(e=>P(c.myField,e)),E(!1),l.my.planes.length!==2?O():(g(),E(!0))}).catch(e=>{document.body.innerHTML=`<button onclick="javascript:location.reload()">reload</button><br><br>${e.stack}`});function R(){if(l.my.planes.length>0)return;let e=["easy","medium","hard","impossible"],s=m("div");e.forEach(o=>{let i=m("button");i.classList.add("level",o),i.textContent=o,i.addEventListener("click",()=>n(o)),s.appendChild(i)}),document.body.appendChild(s);let t=localStorage.getItem("level");n(e.includes(t)?t:"medium");function n(o){!o||l.my.planes.length>0||(localStorage.setItem("level",o),document.querySelectorAll("button.level").forEach(i=>{i.classList.contains(o)?i.classList.add("selected"):i.classList.remove("selected")}))}}async function $(){l=await Promise.resolve({my:{planes:[],shots:[]},opponent:{planes:[],shots:[]}})}function N(){L(document.body,10,(e,s)=>{l.my.planes.length!==2&&(A("my",l.my.planes,I(),e,s),l.my.planes.length===2?(document.querySelectorAll(`#${c.myField} [cell]`).forEach(t=>t.classList.remove("indicator")),document.body.removeChild(document.getElementById(c.planeField)),g()):v())},!0,c.myField,"block")}function g(){L(document.body,10,(e,s)=>B(S(e,s)).then(G),!0,c.opponentField,"block"),Z()}function Z(){for(;l.opponent.planes.length!==2;)A("opponent",l.opponent.planes,y(4),y(10),y(10))}async function G(){let e={easy:()=>[y(10),y(10)],normal:()=>e.easy(),hard:()=>h(l.my.planes.flatMap(n=>n).reverse()[l.opponent.shots.length]),impossible:()=>h(l.my.planes[l.opponent.shots.length][0])},[s,t]=(e[localStorage.getItem("level")]||e.normal)();await T(S(s,t))}function O(){L(document.body,4,e,!1,c.planeField,"block"),e(new Event("init")),v();function e(s){let t=I(),n=t+(s===void 0?0:t>=4?-3:1),o=document.querySelector(`#${c.planeField}`);s&&o.setAttribute("orientation",n);let i=_(n);o.querySelectorAll("[cell]").forEach(a=>i.includes(a.getAttribute("cell"))?a.classList.add("plane-tmp"):a.classList.remove("plane-tmp")),v()}}function v(){let e=I(),s=Array.prototype.slice.call(document.querySelectorAll(`#${c.myField} [cell]`));s.forEach(n=>n.classList.remove("indicator"));let t=s.flatMap(n=>{let[o,i]=h(n.getAttribute("cell")),a=A("my",l.my.planes,e,o,i,!0);return a?a[0]:[]});[...new Set(t)].forEach(n=>document.querySelector(`#${c.myField} [cell='${n}']`).classList.add("indicator"))}function I(){let e=document.querySelector(`#${c.planeField}`),s=e&&+e.getAttribute("orientation")||1;return s>4?1:s}async function B(e){if(!q())return;if(!l.my.shots.includes[e]){l.my.shots.push(e);let t=0;l.opponent.planes.find(o=>o[0]===e)?t=2:l.opponent.planes.find(o=>o.includes(e))&&(t=1);let n=document.querySelector(`#${c.opponentField} [cell='${e}']`);t>0&&n.classList.add("plane"),t===2&&n.classList.add("tip"),t===3&&await s(!0)}await s(D(l.opponent.planes,l.my.shots));async function s(t){E(!0,e),t&&await C("my")}}async function T(e){l.opponent.shots.includes[e]||l.opponent.shots.push(e),E(!1,e),D(l.my.planes,l.opponent.shots)&&await C("opponent")}async function C(e){l.opponent.planes.forEach(o=>o.forEach(i=>document.querySelector(`#${c.opponentField} [cell='${i}']`).classList.add("plane")));let t=document.createElement("div");t.innerHTML=e==="my"?"You won :)":"You lost :(",t.classList.add(e==="my"?"won":"lost");let n=document.createElement("div");n.classList.add("game-over"),n.addEventListener("click",()=>location.reload()),n.appendChild(t),document.body.appendChild(n)}function D(e,s){let t=e.map(o=>o[0]);return s.filter(o=>t.includes(o)).length===2}function P(e,s){s.forEach((t,n)=>{let o=document.querySelector(`#${e} [cell='${t}']`);o.classList.add("plane"),n===0&&o.classList.add("tip")})}function E(e,s){let t=document.getElementById(e?c.opponentField:c.myField);s?n(s):e?l.my.shots.forEach(n):l.opponent.shots.forEach(n);function n(o){let i=t.querySelector(`[cell='${o}']`);i.classList.contains("hit")||i.classList.add("hit")}}function L(e,s,t,n,o,i){let a=s+(n?1:0),d=m("table");o&&d.setAttribute("id",o),i&&d.classList.add(i),new Array(a).fill().forEach((p,r)=>{let F=m("tr");new Array(a).fill().forEach((k,u)=>{let f=m("td");n&&r===0&&u===0?f.innerText="":n&&r===0&&u>0?f.innerText=u:n&&r>0&&u===0?f.innerText=b(r):f.setAttribute("cell",S(r+(n?0:1),u+(n?0:1))),F.appendChild(f)}),d.appendChild(F)}),d.addEventListener("click",p=>{if(p.preventDefault(),p.stopPropagation(),!t)return;let r=p.target.getAttribute("cell");r&&t(...h(r))}),e.appendChild(d)}function _(e,s,t){let o={1:["A2","B1","B2","B3","C2","D1","D2","D3"],2:["B4","A1","A3","B1","B2","B3","C1","C3"],3:["D2","A1","A2","A3","B2","C1","C2","C3"],4:["B1","A2","A4","B2","B3","B4","C2","C4"]}[e];return!s||!t?o:o.map(i=>{let a=h(i);return a[0]+=e===1?s-1:e==2||e==4?s-2:e===3?s-4:s,a[1]+=e===1||e===3?t-2:e==2?t-4:e===4?t-1:t,S(...a)})}function A(e,s,t,n,o,i){if(!(t===1&&n>=1&&n<=10-3&&o>=2&&o<=10-1||t===2&&n>=2&&n<=10-1&&o>=4&&o<=10||t===3&&n>=4&&n<=10&&o>=2&&o<=10-1||t===4&&n>=2&&n<=10-1&&o>=1&&o<=10-3))return;let a=_(t,n,o);if(!s.find(p=>p.find(r=>a.includes(r))!==void 0)){if(i)return a;s.push(a),e==="my"&&P(c.myField,a)}}function m(e){return document.createElement(e)}function y(e){return Math.ceil(Math.random()*e)}function h(e){return/^[A-Z]{1}([1-9]{1}|10)$/.test(e)?[e[0].charCodeAt()-64,+e.replace(/[A-Z]/,"")]:[NaN,NaN]}function S(e,s){return`${b(e)}${s}`}function b(e){return String.fromCharCode(64+e)}function q(){return l.my.shots<=l.opponent.shots}})();</script>
    </body>
</html>
