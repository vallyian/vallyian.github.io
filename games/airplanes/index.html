<html>
    <head>
        <title>Airplanes</title>
        <link rel="manifest" href="manifest.json" />
    </head>
    <body>
        <style>html{background-color:#000;color:#fff;font-family:'Courier New',Courier,monospace;font-size:calc(min(100vw / 12, 100vh / 28))}table{border-collapse:collapse}td{width:1rem;height:1rem;overflow:hidden;font-size:.75rem;overflow:hidden;padding:0;text-align:center}td[cell]{border:1px solid grey}.block{display:inline-block;margin:.5rem}.square{display:inline-block;width:1rem;height:1rem;overflow:hidden;font-size:.75rem}.border{box-shadow:1px 0 0 0 grey,0 1px 0 0 grey,1px 1px 0 0 grey,1px 0 0 0 grey inset,0 1px 0 0 grey inset}.disabled{background-color:grey}.plane{background-color:#87cefa}.hit{background-color:grey}.plane.hit{background-color:orange}.plane.tip.hit{background-color:red}.rotate{width:calc(100% - .5rem)}.game-over{position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.753)}.game-over>*{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);white-space:nowrap}.game-over>.won{color:#adff2f}.game-over>.lost{color:red}</style>
        <script type="module">(()=>{var p=Object.freeze({myField:"my-field",opponentField:"opponent-field",planeField:"plane-field"}),s,I=Object.freeze({max:6,get value(){return+localStorage.getItem("level")||3},set value(e){localStorage.setItem("level",e>=1&&e<=I.max?e:3)},showUi(){s.my.planes.length>0||E("div",{parent:u(),attrs:{id:"level",class:"block"},children:[E("div",{text:"Difficulty"}),E("input",{attrs:{type:"range",min:1,max:6,value:I.value},on:{change(e){I.value=+e.target.value}}})]})},removeUi(){u("#level").remove()}});Promise.resolve().then(async()=>{if(await q(),10<5||10>25)throw Error("GRID_SIZE must be between 5 and 25");if(2<1||2>Math.floor(10*10/16))throw Error(`PLANE_COUNT must be between 1 and ${Math.floor(10*10/16)}`);s.my.planes.length!==2&&(I.showUi(),J()),x(),s.my.planes.length===2&&($(),F(!0))}).catch(e=>{u().innerHTML=`<button onclick="javascript:location.reload()">reload</button><br><br>${e.stack}`});async function q(){s=await Promise.resolve({my:{planes:[],shots:[]},opponent:{planes:[],shots:[]}})}function x(){let e=t=>{if(!B(t)||s.my.planes.length===2)return;let[n,a]=m(t),o=D(n,a,R(),s.my.planes);o&&(s.my.planes.push(o),G(p.myField,o)),A(),s.my.planes.length===2&&(I.removeUi(),u(`#${p.planeField}`).remove(),$())};b("My battlefield",p.myField,10,!0,e),s.my.planes.forEach(t=>G(p.myField,t)),s.my.planes.length!==2&&A(),F(!1)}function $(){let e=t=>{!B(t)||!U()||s.my.shots.includes(t)||K(t).then(Y)};b("Opponent's battlefield",p.opponentField,10,!0,e),z()}function z(){for(;s.opponent.planes.length!==2;){let e=D(y(10),y(10),y(4),s.opponent.planes);e&&s.opponent.planes.push(e)}}async function Y(){let e=()=>{for(;;){let l=[y(10),y(10)];if(!s.opponent.shots.includes(S(...l)))return l}},t=()=>e(),n=()=>e(),a=()=>{let l=s.my.planes.flatMap(i=>i),c=s.opponent.shots;if(!c)return e();let g=c.filter(i=>l.includes(i));if(!g)return e();let H=l.map(i=>i[0]).filter(i=>g.includes(i)),j=g.filter(i=>!H.includes(i));if(!g)return e();let O=[...new Set(j.flatMap(i=>{let[v,N]=m(i),Z=C(7,v-3).map((d,_)=>d+_).filter(d=>d>=1&&d<=10),P=C(7,N-3).map((d,_)=>d+_).filter(d=>d>=1&&d<=10);return Z.flatMap(d=>P.map(_=>[d,_]))}).map(([i,v])=>S(i,v)))].filter(i=>!c.includes(i));if(!O.length)return e();let L=[...new Set(O.flatMap(i=>{let[v,N]=m(i);return[1,2,3,4].flatMap(P=>D(v,N,P,[c],!0)||[])}))];if(L.length)return m(L[y(L.length)-1])},o=()=>a()||e();await Q(S(...([t,n,o,()=>{if(s.my.planes.flatMap(c=>c).filter(c=>s.opponent.shots.includes(c)))return e()},()=>m(s.my.planes.flatMap(l=>l).reverse()[s.opponent.shots.length]),()=>m(s.my.planes[s.opponent.shots.length][0])][I.value-1]||o)()||o()))}function D(e,t,n,a,o){if(!(n===1&&e>=1&&e<=10-3&&t>=2&&t<=10-1||n===2&&e>=2&&e<=10-1&&t>=4&&t<=10||n===3&&e>=4&&e<=10&&t>=2&&t<=10-1||n===4&&e>=2&&e<=10-1&&t>=1&&t<=10-3))return;let r=T(n,e,t),f=a.find(h=>h.find(l=>r.includes(l))!==void 0);if(!(f&&!o))return r}function J(){let e=()=>{let t=R(),n=t+(t>=4?-3:1),a=T(n),o=u(`#${p.planeField}`);o.setAttribute("orientation",n),o.querySelectorAll("[cell]").forEach(r=>a.includes(r.getAttribute("cell"))?r.classList.add("plane"):r.classList.remove("plane")),A()};b("Add plane (click to rotate)",p.planeField,4,!1,e),e(),A()}function A(){let e=Array.prototype.slice.call(V(`#${p.myField} [cell]`));if(s.my.planes.length===2){e.forEach(n=>n.classList.remove("disabled"));return}e.forEach(n=>n.classList.add("disabled"));let t=R();[...new Set(e.flatMap(n=>{let[a,o]=m(n.getAttribute("cell")),r=D(a,o,t,s.my.planes);return r?r[0]:[]}))].forEach(n=>u(`#${p.myField} [cell='${n}']`).classList.remove("disabled"))}function R(){let e=u(`#${p.planeField}`),t=e&&+e.getAttribute("orientation")||1;return t>4?1:t}async function K(e){if(!U()||s.my.shots.includes(e))return;s.my.shots.push(e);let t=await(async()=>{switch(!0){case s.opponent.planes.find(a=>a[0]===e)!==void 0:return 2;case s.opponent.planes.find(a=>a.includes(e))!==void 0:return 1;case!1:return await Promise.resolve(y(3)-1);default:return 0}})(),n=u(`#${p.opponentField} [cell='${e}']`);t>0&&n.classList.add("plane"),t===2&&n.classList.add("tip"),F(!0,e),(t===3||M(s.opponent.planes,s.my.shots))&&await w("my")}async function Q(e){s.opponent.shots.includes[e]||s.opponent.shots.push(e),F(!1,e),M(s.my.planes,s.opponent.shots)&&await w("opponent")}async function w(e){s.opponent.planes.forEach(n=>n.forEach(a=>u(`#${p.opponentField} [cell='${a}']`).classList.add("plane"))),E("div",{parent:u(),attrs:{class:"game-over"},on:{click(){location.reload()}},children:E("div",{text:e==="my"?"You won :)":"You lost :(",attrs:{class:e==="my"?"won":"lost"}})})}function M(e,t){let n=e.map(o=>o[0]);return t.filter(o=>n.includes(o)).length===2}function G(e,t){t.forEach((n,a)=>{let o=u(`#${e} [cell='${n}']`);o.classList.add("plane"),a===0&&o.classList.add("tip")})}function F(e,t){let n=u(`#${e?p.opponentField:p.myField}`);t?a(t):e?s.my.shots.forEach(a):s.opponent.shots.forEach(a);function a(o){let r=n.querySelector(`[cell='${o}']`);r.classList.contains("hit")||r.classList.add("hit")}}function b(e,t,n,a,o){let r=n+(a?1:0);E("div",{parent:u(),text:e,attrs:{id:t,class:"block"},children:E("table",{children:C(r).map((f,h)=>E("tr",{children:C(r).map((l,c)=>E("td",{...(()=>a&&h===0&&c===0?{text:""}:a&&h===0&&c>0?{text:c}:a&&h>0&&c===0?{text:k(h)}:{attrs:{cell:S(h+(a?0:1),c+(a?0:1))}})()}))})),on:{click(f){f.preventDefault(),f.stopPropagation(),o(f.target.getAttribute("cell"))}}})})}function T(e,t,n){let a={1:["A2","B2","B1","B3","C2","D2","D1","D3"],2:["B4","B3","A3","C3","B2","B1","A1","C1"],3:["D2","C2","C1","C3","B2","A2","A1","A3"],4:["B1","B2","A2","C2","B3","B4","A4","C4"]},o=f=>f.map(h=>{let l=m(h);return l[0]+=e===1?t-1:e==2||e==4?t-2:e===3?t-4:t,l[1]+=e===1||e===3?n-2:e==2?n-4:e===4?n-1:n,S(...l)}),r=a[e];return t&&n?o(r):r}function u(e){return e?document.querySelector(e):document.body}function V(e){return document.querySelectorAll(e)}function E(e,t){let n=document.createElement(e);return t&&(t.attrs&&Object.entries(t.attrs).forEach(([a,o])=>o&&n.setAttribute(a,o)),t.text&&(n.innerText=t.text),t.children&&(t.children instanceof Array?t.children.forEach(a=>n.appendChild(a)):n.appendChild(t.children)),t.on&&Object.entries(t.on).forEach(([a,o])=>n.addEventListener(a,o)),t.parent&&t.parent.appendChild(n)),n}function U(){return s.my.shots.length<=s.opponent.shots.length}function C(e,t){return new Array(e).fill(t)}function y(e){return Math.ceil(Math.random()*e)}function B(e){return e===S(...m(e))}function k(e){return String.fromCharCode(64+e)}function S(e,t){return`${k(e)}${t}`}function m(e){return/^[A-Z]{1}[1-9]{1}[0-9]?$/.test(e||"")?[e[0].charCodeAt()-64,+e.replace(/[A-Z]/,"")]:[NaN,NaN]}})();</script>
    </body>
</html>
