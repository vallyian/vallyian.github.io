<html>
    <head>
        <title>Airplanes</title>
    </head>
    <body>
        <style>html{background-color:#000;color:#fff;font-size:32px;font-family:'Courier New',Courier,monospace}button{margin:.25rem;padding:.25rem;background-color:#000;color:#fff;border:1px solid grey}button.selected{background-color:grey}table{border-collapse:collapse}td{width:1rem;height:1rem;overflow:hidden;font-size:.75rem;overflow:hidden;padding:0;text-align:center}td[cell]{border:1px solid grey}.block{display:inline-block;margin:.5rem}.square{display:inline-block;width:1rem;height:1rem;overflow:hidden;font-size:.75rem}.border{box-shadow:1px 0 0 0 #888,0 1px 0 0 #888,1px 1px 0 0 #888,1px 0 0 0 #888 inset,0 1px 0 0 #888 inset}.plane-tmp{background-color:orange}.indicator{background-color:#a9a9a9}.plane{background-color:#87cefa}.hit{background-color:grey}.plane.hit{background-color:orange}.plane.tip.hit{background-color:red}.rotate{width:calc(100% - .5rem)}.game-over{position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.753)}.game-over>*{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);white-space:nowrap}.game-over>.won{color:#adff2f}.game-over>.lost{color:red}</style>
        <script type="module">(()=>{var c={myField:"my-field",opponentField:"opponent-field",planeField:"plane-field"},l;Promise.resolve().then(async()=>{await $(),R(),N(),l.my.planes.forEach(e=>P(c.myField,e)),E(!1),l.my.planes.length!==2?O():(A(),E(!0))}).catch(e=>{document.body.innerHTML=`<button onclick="javascript:location.reload()">reload</button><br><br>${e.stack}`});function R(){if(l.my.planes.length>0)return;let e=["easy","medium","hard","impossible"],n=y("div");e.forEach(s=>{let i=y("button");i.classList.add("level",s),i.textContent=s,i.addEventListener("click",()=>t(s)),n.appendChild(i)}),document.body.appendChild(n);let o=localStorage.getItem("level");t(e.includes(o)?o:"medium");function t(s){!s||l.my.planes.length>0||(localStorage.setItem("level",s),document.querySelectorAll("button.level").forEach(i=>{i.classList.contains(s)?i.classList.add("selected"):i.classList.remove("selected")}))}}async function $(){l=await Promise.resolve({my:{planes:[],shots:[]},opponent:{planes:[],shots:[]}})}function N(){L(document.body,10,(e,n)=>{l.my.planes.length!==2&&(F("my",l.my.planes,I(),e,n),l.my.planes.length===2?(document.querySelectorAll(`#${c.myField} [cell]`).forEach(o=>o.classList.remove("indicator")),document.body.removeChild(document.getElementById(c.planeField)),A()):v())},!0,c.myField,"block")}function A(){L(document.body,10,(e,n)=>B(S(e,n)).then(G),!0,c.opponentField,"block"),Z()}function Z(){for(;l.opponent.planes.length!==2;)F("opponent",l.opponent.planes,u(4),u(10),u(10))}async function G(){let e={easy:()=>[u(10),u(10)],normal:()=>e.easy(),hard:()=>h(l.my.planes.flatMap(t=>t).reverse()[l.opponent.shots.length]),impossible:()=>h(l.my.planes[l.opponent.shots.length][0])},[n,o]=(e[localStorage.getItem("level")]||e.normal)();await T(S(n,o))}function O(){L(document.body,4,e,!1,c.planeField,"block"),e(new Event("init")),v();function e(n){let o=I(),t=o+(n===void 0?0:o>=4?-3:1),s=document.querySelector(`#${c.planeField}`);n&&s.setAttribute("orientation",t);let i=_(t);s.querySelectorAll("[cell]").forEach(a=>i.includes(a.getAttribute("cell"))?a.classList.add("plane-tmp"):a.classList.remove("plane-tmp")),v()}}function v(){let e=I(),n=Array.prototype.slice.call(document.querySelectorAll(`#${c.myField} [cell]`));n.forEach(t=>t.classList.remove("indicator"));let o=n.flatMap(t=>{let[s,i]=h(t.getAttribute("cell")),a=F("my",l.my.planes,e,s,i,!0);return a?a[0]:[]});[...new Set(o)].forEach(t=>document.querySelector(`#${c.myField} [cell='${t}']`).classList.add("indicator"))}function I(){let e=document.querySelector(`#${c.planeField}`),n=e&&+e.getAttribute("orientation")||1;return n>4?1:n}async function B(e){if(!q())return;l.my.shots.push(e);let n=await(async()=>{switch(!0){case l.opponent.planes.find(t=>t[0]===e)!==void 0:return 2;case l.opponent.planes.find(t=>t.includes(e))!==void 0:return 1;case!1:return await Promise.resolve(u(3)-1);default:return 0}})(),o=document.querySelector(`#${c.opponentField} [cell='${e}']`);n>0&&o.classList.add("plane"),n===2&&o.classList.add("tip"),E(!0,e),(n===3||D(l.opponent.planes,l.my.shots))&&await C("my")}async function T(e){l.opponent.shots.includes[e]||l.opponent.shots.push(e),E(!1,e),D(l.my.planes,l.opponent.shots)&&await C("opponent")}async function C(e){l.opponent.planes.forEach(s=>s.forEach(i=>document.querySelector(`#${c.opponentField} [cell='${i}']`).classList.add("plane")));let o=document.createElement("div");o.innerHTML=e==="my"?"You won :)":"You lost :(",o.classList.add(e==="my"?"won":"lost");let t=document.createElement("div");t.classList.add("game-over"),t.addEventListener("click",()=>location.reload()),t.appendChild(o),document.body.appendChild(t)}function D(e,n){let o=e.map(s=>s[0]);return n.filter(s=>o.includes(s)).length===2}function P(e,n){n.forEach((o,t)=>{let s=document.querySelector(`#${e} [cell='${o}']`);s.classList.add("plane"),t===0&&s.classList.add("tip")})}function E(e,n){let o=document.getElementById(e?c.opponentField:c.myField);n?t(n):e?l.my.shots.forEach(t):l.opponent.shots.forEach(t);function t(s){let i=o.querySelector(`[cell='${s}']`);i.classList.contains("hit")||i.classList.add("hit")}}function L(e,n,o,t,s,i){let a=n+(t?1:0),d=y("table");s&&d.setAttribute("id",s),i&&d.classList.add(i),new Array(a).fill().forEach((p,r)=>{let g=y("tr");new Array(a).fill().forEach((k,f)=>{let m=y("td");t&&r===0&&f===0?m.innerText="":t&&r===0&&f>0?m.innerText=f:t&&r>0&&f===0?m.innerText=b(r):m.setAttribute("cell",S(r+(t?0:1),f+(t?0:1))),g.appendChild(m)}),d.appendChild(g)}),d.addEventListener("click",p=>{if(p.preventDefault(),p.stopPropagation(),!o)return;let r=p.target.getAttribute("cell");r&&o(...h(r))}),e.appendChild(d)}function _(e,n,o){let s={1:["A2","B1","B2","B3","C2","D1","D2","D3"],2:["B4","A1","A3","B1","B2","B3","C1","C3"],3:["D2","A1","A2","A3","B2","C1","C2","C3"],4:["B1","A2","A4","B2","B3","B4","C2","C4"]}[e];return!n||!o?s:s.map(i=>{let a=h(i);return a[0]+=e===1?n-1:e==2||e==4?n-2:e===3?n-4:n,a[1]+=e===1||e===3?o-2:e==2?o-4:e===4?o-1:o,S(...a)})}function F(e,n,o,t,s,i){if(!(o===1&&t>=1&&t<=10-3&&s>=2&&s<=10-1||o===2&&t>=2&&t<=10-1&&s>=4&&s<=10||o===3&&t>=4&&t<=10&&s>=2&&s<=10-1||o===4&&t>=2&&t<=10-1&&s>=1&&s<=10-3))return;let a=_(o,t,s);if(!n.find(p=>p.find(r=>a.includes(r))!==void 0)){if(i)return a;n.push(a),e==="my"&&P(c.myField,a)}}function y(e){return document.createElement(e)}function u(e){return Math.ceil(Math.random()*e)}function h(e){return/^[A-Z]{1}([1-9]{1}|10)$/.test(e)?[e[0].charCodeAt()-64,+e.replace(/[A-Z]/,"")]:[NaN,NaN]}function S(e,n){return`${b(e)}${n}`}function b(e){return String.fromCharCode(64+e)}function q(){return l.my.shots.length<=l.opponent.shots.length}})();</script>
    </body>
</html>
