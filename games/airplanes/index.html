<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Airplanes</title>
        <meta charset="utf-8" />
        <meta name="description" content="Airplanes">
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="theme_color" content="#000000" />
        <link rel="icon" type="image/x-icon" href="favicon.ico" />
        <link rel='shortcut icon' type='image/x-icon' href='favicon.ico' />
        <link rel="manifest" href="manifest.json" />
        <style>html{background-color:#000;color:#fff;font-family:'Courier New',Courier,monospace;font-size:calc(min(100vw / 12, 100vh / 29))}[type=range]{width:11rem}body{margin:1rem}body>*{display:flex;flex-direction:column;align-items:center;text-align:center}body>:not(link,style,script,:last-child){margin-bottom:1rem}.title{align-items:center}table{border-collapse:collapse}td{width:1rem;height:1rem;overflow:hidden;font-size:.75rem;overflow:hidden;padding:0;text-align:center}td[cell]{border:1px solid grey}.square{display:inline-block;width:1rem;height:1rem;overflow:hidden;font-size:.75rem}.border{box-shadow:1px 0 0 0 grey,0 1px 0 0 grey,1px 1px 0 0 grey,1px 0 0 0 grey inset,0 1px 0 0 grey inset}.disabled{background-color:grey}.plane{background-color:#87cefa}.hit{background-color:grey}.plane.hit{background-color:orange}.plane.tip.hit{background-color:red}.rotate{width:calc(100% - .5rem)}.game-over{position:fixed;top:0;bottom:0;left:0;right:0;background-color:rgba(0,0,0,.753)}.game-over>*{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);white-space:nowrap}.game-over>.won{color:#adff2f}.game-over>.lost{color:red}</style>
        <script type="module">(()=>{var l=class{static#t="grid";static#n=10;static get min(){return 5}static get max(){return 25}static get value(){return this.#e(localStorage.getItem(this.#t))}static set value(e){localStorage.setItem(this.#t,this.#e(e))}static#e(e){return e=+e,isFinite(e)&&e>=this.min&&e<=this.max?e:this.#n}},d=class{static#t="planes";static get#n(){return Math.min(2,this.max)}static get min(){return 1}static get max(){return 2*Math.floor(l.value/4)}static get value(){return this.#e(localStorage.getItem(this.#t))}static set value(e){localStorage.setItem(this.#t,this.#e(e))}static#e(e){return e=+e,isFinite(e)&&e>=this.min&&e<=this.max?e:this.#n}},v=class{static#t="level";static#n=3;static get min(){return 1}static get max(){return 6}static get value(){return this.#e(localStorage.getItem(this.#t))}static set value(e){localStorage.setItem(this.#t,this.#e(e))}static#e(e){return e=+e,isFinite(e)&&e>=this.min&&e<=this.max?e:this.#n}};var y=!0,a;Promise.resolve().then(async()=>{"serviceWorker"in navigator&&await navigator.serviceWorker.register("service.js").catch(console.err),await Z(),a.my.planes.length!==d.value&&A().settings().add(),A().addMyBattlefield(),a.my.planes.length===d.value&&(A().addOpponentBattlefield(),z(!0))}).catch(t=>h().innerHTML=`<button onclick="javascript:location.reload()">reload</button><br><br>${t.stack}`);function A(){return Object.freeze({settings:()=>Object.freeze({add:()=>{A().settings().remove(),t(),e(),n(),s()},remove:()=>P(".settings").forEach(r=>r.remove())}),addMyBattlefield:i,addOpponentBattlefield:f});function t(){P(".grid-size").forEach(r=>r.remove()),c("div",{parent:h(),attrs:{class:"settings grid-size"},children:[c("div",{text:`Grid size (${l.value}x${l.value})`}),c("label",{attrs:{for:"grid-size"},children:c("input",{attrs:{name:"grid-size",type:"range",min:l.min,max:l.max,value:l.value},on:{change(r){l.value=+r.target.value,a.my.planes=[],A().settings().add(),i()}}})})]})}function e(){P(".plane-count").forEach(r=>r.remove()),c("div",{parent:h(),attrs:{class:"settings plane-count"},children:[c("div",{text:`Planes (${d.value})`}),c("label",{attrs:{for:"plane-count"},children:c("input",{attrs:{name:"plane-count",type:"range",min:d.min,max:d.max,value:d.value},on:{change(r){d.value=+r.target.value,a.my.planes=[],A().settings().add(),i()}}})})]})}function n(){P(".difficulty").forEach(r=>r.remove()),c("div",{parent:h(),attrs:{class:"settings difficulty"},children:[c("div",{text:`Difficulty (${v.value})`}),c("label",{attrs:{for:"difficulty"},children:c("input",{attrs:{name:"difficulty",type:"range",min:v.min,max:v.max,value:v.value},on:{change(r){v.value=+r.target.value,a.my.planes=[],A().settings().add(),i()}}})})]})}function s(){P(".plane-field").forEach(r=>r.remove()),c("div",{parent:h(),attrs:{class:"settings plane-field"},children:g(`Add plane
(click to rotate)`,4,!1,H)}),H(),k()}function i(){P(".my-field").forEach(r=>r.remove()),c("div",{parent:h(),attrs:{class:"my-field"},children:g("My battlefield",l.value,!0,_)}),a.my.planes.forEach(T),a.my.planes.length!==d.value&&k(),z(!1)}function f(){P(".opponent-field").forEach(r=>r.remove()),c("div",{parent:h(),attrs:{class:"opponent-field"},children:g("Opponent's battlefield",l.value,!0,Q)}),J()}function g(r,u,p,x){let $=u+(p?1:0);return[c("div",{text:r}),c("table",{children:w($).map((C,E)=>c("tr",{children:w($).map((D,o)=>c("td",{...(()=>p&&E===0&&o===0?{text:""}:p&&E===0&&o>0?{text:o}:p&&E>0&&o===0?{text:Y(E)}:{attrs:{cell:M(E+(p?0:1),o+(p?0:1))}})()}))})),on:{click(C){C.preventDefault(),C.stopPropagation(),x(C.target.getAttribute("cell"))}}})]}}async function Z(){a=y?await Promise.resolve({my:{planes:[],shots:[]},opponent:{planes:[],shots:[]}}):await Promise.resolve({my:{planes:[],shots:[]},opponent:{planes:[],shots:[]}})}function _(t){if(!W(t)||a.my.planes.length===d.value)return;let[e,n]=b(t),s=L(e,n,j(),a.my.planes);s&&(a.my.planes.push(s),T(s)),k(),a.my.planes.length===d.value&&(A().settings().remove(),A().addOpponentBattlefield())}function J(){if(y)for(;a.opponent.planes.length!==d.value;){let t=L(S(l.value),S(l.value),S(4),a.opponent.planes);t&&a.opponent.planes.push(t)}}async function K(){if(!y)return;let t=()=>{for(;;){let u=[S(l.value),S(l.value)];if(!a.opponent.shots.includes(M(...u)))return u}},e=()=>t(),n=()=>t(),s=()=>{let u=a.my.planes.flatMap(o=>o),p=a.opponent.shots;if(!p)return t();let x=p.filter(o=>u.includes(o));if(!x)return t();let $=u.map(o=>o[0]).filter(o=>x.includes(o)),C=x.filter(o=>!$.includes(o));if(!x)return t();let E=[...new Set(C.flatMap(o=>{let[O,I]=b(o),F=w(7,O-3).map((m,B)=>m+B).filter(m=>m>=1&&m<=l.value),R=w(7,I-3).map((m,B)=>m+B).filter(m=>m>=1&&m<=l.value);return F.flatMap(m=>R.map(B=>[m,B]))}).map(([o,O])=>M(o,O)))].filter(o=>!p.includes(o));if(!E.length)return t();let D=[...new Set(E.flatMap(o=>{let[O,I]=b(o);return[1,2,3,4].flatMap(R=>L(O,I,R,[p],!0)||[])}))];if(D.length)return b(D[S(D.length)-1])},i=()=>s()||t();await U(M(...([e,n,i,()=>{if(a.my.planes.flatMap(p=>p).filter(p=>a.opponent.shots.includes(p)))return t()},()=>b(a.my.planes.flatMap(u=>u).reverse()[a.opponent.shots.length]),()=>b(a.my.planes[a.opponent.shots.length][0])][v.value-1]||i)()||i()))}function L(t,e,n,s,i){if(!(n===1&&t>=1&&t<=l.value-3&&e>=2&&e<=l.value-1||n===2&&t>=2&&t<=l.value-1&&e>=4&&e<=l.value||n===3&&t>=4&&t<=l.value&&e>=2&&e<=l.value-1||n===4&&t>=2&&t<=l.value-1&&e>=1&&e<=l.value-3))return;let f=G(n,t,e),g=s.find(r=>r.find(u=>f.includes(u))!==void 0);if(!(g&&!i))return f}function H(){let t=j(),e=t+(t>=4?-3:1),n=G(e),s=h(".plane-field");s.setAttribute("orientation",e),s.querySelectorAll("[cell]").forEach(i=>n.includes(i.getAttribute("cell"))?i.classList.add("plane"):i.classList.remove("plane")),k()}function k(){let t=Array.prototype.slice.call(P(".my-field [cell]"));if(a.my.planes.length===d.value){t.forEach(n=>n.classList.remove("disabled"));return}t.forEach(n=>n.classList.add("disabled"));let e=j();[...new Set(t.flatMap(n=>{let[s,i]=b(n.getAttribute("cell")),f=L(s,i,e,a.my.planes);return f?f[0]:[]}))].forEach(n=>h(`.my-field [cell='${n}']`).classList.remove("disabled"))}function j(){let t=h(".plane-field"),e=t&&+t.getAttribute("orientation")||1;return e>4?1:e}async function Q(t){if(!W(t)||!V()||a.my.shots.includes(t)||!y&&!await Promise.resolve(!0))return;a.my.shots.push(t);let e=await(async()=>{switch(!0){case(y&&a.opponent.planes.find(s=>s[0]===t)!==void 0):return 2;case(y&&a.opponent.planes.find(s=>s.includes(t))!==void 0):return 1;case!y:return await Promise.resolve(S(3)-1);default:return 0}})(),n=h(`.opponent-field [cell='${t}']`);e>0&&n.classList.add("plane"),e===2&&n.classList.add("tip"),z(!0,t),(e===3||q(a.opponent.planes,a.my.shots))&&await N("my"),y&&K()}async function U(t){a.opponent.shots.includes[t]||a.opponent.shots.push(t),z(!1,t),q(a.my.planes,a.opponent.shots)&&await N("opponent")}async function N(t){(y?a.opponent.planes:await Promise.resolve(a.opponent.planes)).forEach(n=>n.forEach(s=>h(`.opponent-field [cell='${s}']`).classList.add("plane"))),c("div",{parent:h(),attrs:{class:"game-over"},on:{click(){location.reload()}},children:c("div",{text:t==="my"?"You won :)":"You lost :(",attrs:{class:t==="my"?"won":"lost"}})})}function q(t,e){let n=t.map(i=>i[0]);return e.filter(i=>n.includes(i)).length===d.value}function T(t){t.forEach((e,n)=>{let s=h(`.my-field [cell='${e}']`);s.classList.add("plane"),n===0&&s.classList.add("tip")})}function z(t,e){let n=h(`.${t?"opponent-field":"my-field"}`);e?s(e):t?a.my.shots.forEach(s):a.opponent.shots.forEach(s);function s(i){let f=n.querySelector(`[cell='${i}']`);f.classList.contains("hit")||f.classList.add("hit")}}function G(t,e,n){let s={1:["A2","B2","B1","B3","C2","D2","D1","D3"],2:["B4","B3","A3","C3","B2","B1","A1","C1"],3:["D2","C2","C1","C3","B2","A2","A1","A3"],4:["B1","B2","A2","C2","B3","B4","A4","C4"]},i=g=>g.map(r=>{let u=b(r);return u[0]+=t===1?e-1:t==2||t==4?e-2:t===3?e-4:e,u[1]+=t===1||t===3?n-2:t==2?n-4:t===4?n-1:n,M(...u)}),f=s[t];return e&&n?i(f):f}function h(t){return t?document.querySelector(t):document.body}function P(t){return document.querySelectorAll(t)}function c(t,e){let n=document.createElement(t);return e&&(e.attrs&&Object.entries(e.attrs).forEach(([s,i])=>i&&n.setAttribute(s,i)),e.text&&(n.innerText=e.text),e.children&&(e.children instanceof Array?e.children.forEach(s=>n.appendChild(s)):n.appendChild(e.children)),e.on&&Object.entries(e.on).forEach(([s,i])=>n.addEventListener(s,i)),e.parent&&e.parent.appendChild(n)),n}function V(){return a.my.shots.length<=a.opponent.shots.length}function w(t,e){return new Array(t).fill(e)}function S(t){return Math.ceil(Math.random()*t)}function W(t){return t===M(...b(t))}function Y(t){return String.fromCharCode(64+t)}function M(t,e){return`${Y(t)}${e}`}function b(t){return/^[A-Z]{1}[1-9]{1}[0-9]?$/.test(t||"")?[t[0].charCodeAt()-64,+t.replace(/[A-Z]/,"")]:[NaN,NaN]}})();</script>
    </head>
    <body>
        <noscript>JavaScript is disabled.</noscript>
    </body>
</html>
